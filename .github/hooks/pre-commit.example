#!/bin/bash
#
# Git pre-commit hook to lint Python files
# Runs flake8 on staged Python files before allowing commit
#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if flake8 is available
if ! command -v flake8 &> /dev/null; then
    echo -e "${YELLOW}Warning: flake8 not found. Install with: pip install flake8${NC}"
    echo "Skipping linting..."
    exit 0
fi

# Get list of staged Python files
STAGED_PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$')

if [ -z "$STAGED_PYTHON_FILES" ]; then
    echo -e "${GREEN}No Python files staged for commit. Skipping linting.${NC}"
    exit 0
fi

echo -e "${GREEN}Running flake8 on staged Python files...${NC}"

# Run flake8 on staged files
# Configuration:
#   --max-line-length=120: Allow lines up to 120 characters
#   --ignore=E501: Ignore line too long errors (handled by max-line-length)
#   --exclude: Exclude common directories
flake8 --max-line-length=120 --ignore=E501,W503 \
    --exclude=.git,__pycache__,*.pyc,venv,env,.venv \
    $STAGED_PYTHON_FILES

# Capture exit code
EXIT_CODE=$?

if [ $EXIT_CODE -ne 0 ]; then
    echo -e "\n${RED}❌ Linting failed! Please fix the errors above before committing.${NC}"
    echo -e "${YELLOW}To skip this check (not recommended), use: git commit --no-verify${NC}"
    exit 1
else
    echo -e "${GREEN}✅ All Python files passed linting!${NC}"
    exit 0
fi

